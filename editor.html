<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vi-inspired Editor Final</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
body { font-family:sans-serif; margin:0; }
.toolbar { display:flex; gap:8px; padding:6px; background:#eee; border-bottom:1px solid #ccc; flex-wrap:wrap; }
.line { padding:4px 8px; border-bottom:1px dashed #ddd; cursor:pointer; min-height:1.5em; }
.line.selected { background:#d0ebff; }
.line:empty::before { content:"\00a0"; }
input.line-input { width:100%; border:none; outline:none; padding:4px 8px; border-bottom:1px dashed #ddd; font-family:inherit; font-size:inherit; }
.line, .line-input {
  white-space: pre;  /* í…ìŠ¤íŠ¸ ìë™ ì¤„ ë°”ê¿ˆ ë°©ì§€ */
  overflow-x: auto;     /* ê¸¸ë©´ ê°€ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
}
    .toolbar {
      position: sticky;      /* ìŠ¤í¬ë¡¤ ì‹œ ìƒë‹¨ì— ê³ ì • */
      top: 0;                /* í™”ë©´ ìµœìƒë‹¨ */
      z-index: 1000;         /* ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— í‘œì‹œ */
      background: #eee;
      padding: 6px;
      border-bottom: 1px solid #ccc;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* optional: ëª¨ë°”ì¼ì—ì„œ íŒ¨ë”© ì¦ê°€ */
    @media (max-width: 768px) {
      .toolbar {
        padding: 10px;
      }
    }
    </style>
  </head>
  <body x-data="editorApp">

    <!-- íˆ´ë°” -->
    <div class="toolbar">
      <button @click="toggleMode()">ëª¨ë“œ: <span x-text="mode"></span></button>
      <template x-if="mode==='editor'">
        <div style="display:flex; gap:4px;">
          <button @click="manualCut()">âœ‚ ì˜ë¼ë‚´ê¸°</button>
          <button @click="manualCopy()">ğŸ“„ ë³µì‚¬</button>
          <button @click="paste()">ğŸ“‹ ë¶™ì—¬ë„£ê¸°</button>
          <button @click="replace()">â™» ì¹˜í™˜</button>
          <button @click="selectAll()">ì „ì²´ ì„ íƒ</button>
          <button @click="deleteSelection()">ì„ íƒ ì˜ì—­ ì‚­ì œ</button>
        </div>
      </template>
      <button @click="undo()" :disabled="undoStack.length===0">â†© undo</button>
      <button @click="redo()" :disabled="redoStack.length===0">â†ª redo</button>
    </div>

    <!-- ë³¸ë¬¸ -->
    <div>
      <!-- ì—ë””í„° ëª¨ë“œ -->
      <template x-if="mode==='editor'">
        <div>
          <template x-for="(line, i) in lines" :key="i">
            <div class="line"
                 :class="{selected: selection && i>=selection.start && i<=selection.end}"
                 @click="toggleSelect(i)"
                 x-text="line">
            </div>
          </template>
        </div>
      </template>

      <!-- í…ìŠ¤íŠ¸ ëª¨ë“œ -->
      <template x-if="mode==='text'">
        <div>
          <template x-for="(line,i) in lines" :key="i">
            <input class="line-input" type="text"
                                      :value="line"
                                      @input="lines[i]=$event.target.value"
                                      @keydown.enter.prevent="insertLine(i,$event)" />
          </template>
        </div>
      </template>
    </div>

    <script>
      document.addEventListener("alpine:init",()=>{
        Alpine.data("editorApp",()=>({
          mode:"editor",
          lines:["ì²« ì¤„","ë‘˜ì§¸ ì¤„","ì…‹ì§¸ ì¤„"],
          selection:null,
          undoStack:[],
          redoStack:[],

          toggleMode(){ this.mode = this.mode==="editor" ? "text":"editor"; this.selection=null; },

          toggleSelect(i) {
            if (!this.selection) {
              // ì²˜ìŒ í´ë¦­: start = end = i
              this.selection = { start: i, end: i };
              this.lastClicked = i; // ìµœê·¼ í´ë¦­ ê¸°ë¡
              return;
            }

            // ìµœê·¼ í´ë¦­í•œ ìª½ì„ ê¸°ì¤€ìœ¼ë¡œ ë²”ìœ„ ì¡°ì •
            if (i >= this.lastClicked) {
              this.selection.start = this.lastClicked;
              this.selection.end = i;
            } else {
              this.selection.start = i;
              this.selection.end = this.lastClicked;
            }

            // ìµœê·¼ í´ë¦­ ì—…ë°ì´íŠ¸
            this.lastClicked = i;
          },

          getSelectedLines(){
            if(!this.selection) return [];
            return this.lines.slice(this.selection.start,this.selection.end+1);
          },
          selectAll() {
            if(this.lines.length === 0) return;
            this.selection = { start: 0, end: this.lines.length - 1 };
          },

          deleteSelection() {
            if(!this.selection) return;
            const { start, end } = this.selection;
            const oldLines = this.lines.slice(start, end + 1);

            const cmd = {
              do: () => {
                this.lines.splice(start, end - start + 1);
                this.selection = null;
              },
              undo: () => {
                this.lines.splice(start, 0, ...oldLines);
              }
            };

            this.execute(cmd);
          },

          execute(cmd){
            cmd.do();
            this.undoStack.push(cmd);
            this.redoStack=[];
          },

          async writeClipboard(text,manual=false){
            if(!manual) return;
            try{ await navigator.clipboard.writeText(text); }
            catch(e){ console.warn("Clipboard write failed",e); }
          },

          manualCopy(){
            if(!this.selection) return;
            const text = this.getSelectedLines().join('\n');
            this.writeClipboard(text,true);
            this.selection=null;
          },

          manualCut(){
            if(!this.selection) return;
            const {start,end}=this.selection;
            const oldLines = this.getSelectedLines();
            const cmd = {
              do:()=>{ this.lines.splice(start,end-start+1); this.selection=null; },
              undo:()=>{ this.lines.splice(start,0,...oldLines); },
              manual:()=>this.writeClipboard(oldLines.join('\n'),true)
            };
            this.execute(cmd);
            cmd.manual();
          },

          async paste(){
            try{
              const text = await navigator.clipboard.readText();
              if(!text) return;
              const linesToInsert = text.split('\n');
              const index = this.selection ? this.selection.end : this.lines.length-1;
              const cmd = {
                do:()=>{ this.lines.splice(index+1,0,...linesToInsert); this.selection=null; },
                undo:()=>{ this.lines.splice(index+1,linesToInsert.length); }
              };
              this.execute(cmd);
            }catch(e){ console.warn("Clipboard read failed",e); }
          },

          async replace(){
            if(!this.selection) return;
            const {start,end}=this.selection;
            try{
              const text = await navigator.clipboard.readText();
              if(!text) return;
              const newLines = text.split('\n');
              const oldLines = this.lines.slice(start,end+1);
              const cmd = {
                do:()=>{ this.lines.splice(start,end-start+1,...newLines); this.selection=null; },
                undo:()=>{ this.lines.splice(start,newLines.length,...oldLines); }
              };
              this.execute(cmd);
            }catch(e){ console.warn("Clipboard read failed",e); }
          },

          insertLine(i, event) {
            const input = event.target;
            const cursorPos = input.selectionStart;
            const value = input.value; // ìµœì‹  ê°’ ì‚¬ìš©
            const before = value.slice(0, cursorPos);
            const after = value.slice(cursorPos);

            const cmd = {
              do: () => {
                // ê¸°ì¡´ ì¤„ê³¼ ìƒˆ ì¤„ë¡œ ë¶„ë¦¬
                this.lines.splice(i, 1, before, after);

                // DOM ë Œë”ë§ í›„ ì»¤ì„œ ì´ë™
                setTimeout(() => {
                  const inputs = document.querySelectorAll('input.line-input');
                  const nextInput = inputs[i + 1];
                  if (nextInput) {
                    nextInput.focus();
                    nextInput.setSelectionRange(0, 0);
                  }
                }, 0);
              },
              undo: () => {
                this.lines.splice(i, 2, value);
                setTimeout(() => {
                  const inputs = document.querySelectorAll('input.line-input');
                  if (inputs[i]) inputs[i].focus();
                }, 0);
              }
            };

            this.execute(cmd);
          },

          undo(){
            if(this.undoStack.length===0) return;
            const cmd = this.undoStack.pop();
            cmd.undo?.();
            this.redoStack.push(cmd);
          },

          redo(){
            if(this.redoStack.length===0) return;
            const cmd = this.redoStack.pop();
            cmd.do?.();
            this.undoStack.push(cmd);
          }

        }))
      });
    </script>

  </body>
</html>
