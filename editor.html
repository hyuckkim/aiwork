<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="manifest" href="/aiwork/manifest.json" />
  <meta name="theme-color" content="#000000" />
  <title>Vi-inspired Editor</title>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <link id="hljs-theme-link" rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/styles/default.min.css">
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/highlight.min.js"></script>
  <style>
/* ê³µí†µ */
body {
  font-family: sans-serif;
  margin: 0;
  min-height: 100vh;
  overflow-x: hidden;
}

/* íˆ´ë°” */
.toolbar {
  position: sticky;
  top: 0;
  z-index: 1000;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 6px;
  background: #eee;
  border-bottom: 1px solid #ccc;
}

/* íŒŒì¼ íƒ­ */
.file-tabs {
  display: flex;
  width: 100%;
  /* í™”ë©´ ì „ì²´ ë„ˆë¹„ ì‚¬ìš© */
  gap: 4px;
  padding: 4px;
  overflow-x: auto;
  white-space: nowrap;
}

.file-tabs button {
  flex: 0 0 auto;
  /* ë²„íŠ¼ í¬ê¸° ìœ ì§€ */
  padding: 4px 8px;
}

/* ê²€ìƒ‰ ì…ë ¥ */
.toolbar input[type="text"] {
  padding: 4px;
  font-size: 14px;
}

/* ì—ë””í„° ì¤„ */
.line,
.line-input {
  font-size: 16px;
  line-height: 2em;
  min-height: 2em;
  padding: 4px 8px;
  box-sizing: border-box;
  overflow-x: auto;
  white-space: pre;
  /* hljs ë®ì–´ì“°ê¸° ë°©ì§€ */
  font-family: inherit;
  cursor: pointer;

  /* ë°‘ì¤„ */
  border-bottom: 1px dashed #ddd;
}

.line:empty::before {
  content: "\00a0";
  /* ë¹ˆ ì¤„ í‘œì‹œ */
}

/* ì„ íƒ/ê°•ì¡° */
.line.selected {
  background: #d0ebff;
}

.line.highlighted,
.line-input.highlighted {
  background-color: #ffe066;
  /* ë°ì€ ë…¸ë€ìƒ‰ ê°•ì¡° */
  transition: background-color 0.3s ease;
}

/* ì¸í’‹ ì „ìš© */
input.line-input {
  width: 100%;
  border: none;
  /* ìƒë‹¨/ì¢Œìš° border ì œê±° */
  border-bottom: 1px dashed #ddd;
  /* ë°‘ì¤„ ìœ ì§€ */
  outline: none;
  background: transparent;
  color: inherit;
  cursor: text;
}

/* ëª¨ë‹¬ */
.modal {
  display: flex;
  position: fixed;
  inset: 0;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.5);
  z-index: 2000;
}

/* Highlight.js */
.line span.hljs {
  white-space: inherit;
  /* ë¶€ëª¨ ìƒì† */
}
  </style>
</head>

<body x-data="EditorApp()">

  <!-- Highlight.js ì„¤ì • ëª¨ë‹¬ -->
  <div id="highlightSettingsModal" class="modal" x-show="showHighlightModal" x-cloak>
    <div style="background: white; padding: 20px; border-radius: 8px; width: 320px; max-width: 90%;">
      <h2 style="margin-top:0;">Highlight.js ì„¤ì •</h2>

      <!-- ì–¸ì–´ ì„ íƒ -->
      <label for="hljsLanguage" style="display:block; margin-top:10px;">ì–¸ì–´ ì„ íƒ</label>
      <select id="hljsLanguage" x-model="selectedLanguage" style="width:100%; padding:6px;">
        <template x-for="lang in availableLanguages" :key="lang">
          <option :value="lang" x-text="lang" :selected="lang===selectedLanguage"></option>
        </template>
      </select>

      <!-- í…Œë§ˆ ì„ íƒ -->
      <label for="hljsTheme" style="display:block; margin-top:10px;">í…Œë§ˆ ì„ íƒ</label>
      <select id="hljsTheme" x-model="selectedTheme" style="width:100%; padding:6px;">
        <template x-for="theme in availableThemes" :key="theme">
          <option :value="theme" x-text="theme" :selected="theme===selectedTheme"></option>
        </template>
      </select>

      <!-- ë²„íŠ¼ ì˜ì—­ -->
      <div style="margin-top:16px; display:flex; justify-content:flex-end; gap:8px;">
        <button @click="showHighlightModal=false">ì·¨ì†Œ</button>
        <button @click="applyHighlightSettings()">í™•ì¸</button>
      </div>
    </div>
  </div>


  <!-- íˆ´ë°” -->
  <div class="toolbar">
    <div class="file-tabs" x-show="fileVisible" style="display:flex; gap:4px; padding:4px;">
      <template x-for="(file, i) in files" :key="i">
        <button @click="switchFile(i)" :style="currentFileIndex === i ? 'background-color:#7dd3fc;' : ''">
          File <span x-text="i+1"></span>
        </button>
      </template>
      <button
        @click="files.push(generateFile('ì²« ë²ˆì§¸ ì¤„', 'ë‘ ë²ˆì§¸ ì¤„')); switchFile(files.length-1)">+</button>
    </div>
    <div x-show="searchVisible" style="display:flex; align-items:center; gap:4px; margin-left:16px;">
      <input type="text" placeholder="ê²€ìƒ‰â€¦" x-model="searchQuery" @input="runSearch(lines)" @keyup.enter="searchNext()"
        style="padding:4px; font-size:14px;" />
      <button @click="searchPrev()">â–²</button>
      <button @click="searchNext()">â–¼</button>
      <span x-text="searchResults.length ? (currentResult + 1) + ' of ' + searchResults.length : '0 of 0'"></span>
    </div>
    <button @click="toggleMode()">ëª¨ë“œ: <span x-text="mode"></span></button>
    <template x-if="mode==='editor'">
      <div style="display:flex; gap:4px;">
        <button @click="manualCut()">âœ‚ ì˜ë¼ë‚´ê¸°</button>
        <button @click="manualCopy()">ğŸ“„ ë³µì‚¬</button>
        <button @click="paste()">ğŸ“‹ ë¶™ì—¬ë„£ê¸°</button>
        <button @click="replace()">â™» ì¹˜í™˜</button>
        <button @click="selectAll()">ì „ì²´ ì„ íƒ</button>
        <button @click="deleteSelection()">ì„ íƒ ì˜ì—­ ì‚­ì œ</button>
      </div>
    </template>
    <button @click="undo()" :disabled="undoStack.length===0">â†© undo</button>
    <button @click="redo()" :disabled="redoStack.length===0">â†ª redo</button>
    <button @click="showHighlightModal = true">ğŸ¨</button>
    <button @click="fileVisible = !fileVisible">ğŸ“</button>
    <button @click="searchVisible = !searchVisible">ğŸ”</button>
  </div>

  <!-- ë³¸ë¬¸ -->
  <div id="editor-container">
    <!-- ì—ë””í„° ëª¨ë“œ -->
    <template x-if="mode==='editor'">
      <div class="hljs">
        <template x-for="(line, i) in lines" :key="line.id">
          <div class="line" :class="{selected: selection && i>=selection.start && i<=selection.end}"
            @click="toggleSelect(i)" x-html="hljs.highlight(line.text, {language: selectedLanguage}).value">
          </div>
        </template>
      </div>
    </template>

    <!-- í…ìŠ¤íŠ¸ ëª¨ë“œ -->
    <template x-if="mode==='text'">
      <div class="hljs">
        <template x-for="(line,i) in lines" :key="line.id">
          <input class="line-input" type="text" x-model="lines[i].text" @focus="lines[i]._oldText = lines[i].text"
            @blur="recordEdit(i)" @keyup.enter.prevent="insertLine(i, $event)"
            @keyup.backspace="mergeWithPrev(i,$event)" enterkeyhint="enter" />

        </template>
      </div>
    </template>
  </div>

  <script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/aiwork/sw.js', { scope: '/aiwork/editor.html' })
    .then(() => console.log('Service Worker Registered'));
}
  </script>
  <script>
// ìŠ¤ëƒ…ìƒ·: í˜„ì¬ ë¼ì¸ì„ ê¹Šê²Œ ë³µì‚¬í•˜ê³ , ë¶ˆë³€ìœ¼ë¡œ ë³´ê´€
function snapshotLines(lines) {
  const snap = lines.map(l => ({ id: l.id, text: l.text }));
  // ê°œë°œ ì¤‘ ì°¸ì¡° ëˆ„ìˆ˜ ì¡ìœ¼ë ¤ë©´ ì£¼ì„ í•´ì œí•´ì„œ ë™ê²°í•´ë„ ì¢‹ìŒ
  // snap.forEach(o => Object.freeze(o));
  // Object.freeze(snap);
  return snap;
}

// ì ìš©: ìŠ¤ëƒ…ìƒ·ì„ ê¸°ë°˜ìœ¼ë¡œ "í•­ìƒ ìƒˆ ê°ì²´"ë¥¼ ë§Œë“¤ì–´ DOMì— ê½‚ê¸°
function materialize(snapshot) {
  return snapshot.map(l => ({ id: l.id, text: l.text }));
}
function generateFile(...lines) {
  return {
    lines: lines.map((l, i) => ({ id: i + 1, text: l})),
    undoStack: [],
    redoStack: [],
    scroll: 0,
    nextId: lines.length + 1,
  }
}

function SearchModule() {
  return {
    searchQuery: '',
    searchResults: [],
    currentResult: -1,
    lastQuery: '',
    runSearch(lines) {
      if (!this.searchQuery) {
        this.searchResults = [];
        this.currentResult = -1;
        this.lastQuery = '';
        // ì´ì „ í•˜ì´ë¼ì´íŠ¸ ì œê±°
        document.querySelectorAll('.highlighted').forEach(el => {
          el.classList.remove('highlighted');
        });
        return;
      }

      // ê²€ìƒ‰ì–´ê°€ ë°”ë€Œì—ˆì„ ë•Œë§Œ ìƒˆë¡œ ê³„ì‚°
      if (this.searchQuery !== this.lastQuery) {
        this.searchResults = lines
          .map((line, i) => line.text.includes(this.searchQuery) ? i : -1)
          .filter(i => i >= 0);

        this.currentResult = this.searchResults.length ? 0 : -1;
        this.lastQuery = this.searchQuery;
      }
    },

    searchNext() {
      if (!this.searchResults.length) return;
      this.currentResult = (this.currentResult + 1) % this.searchResults.length;
      this.highlightSearch();
    },

    searchPrev() {
      if (!this.searchResults.length) return;
      this.currentResult = (this.currentResult - 1 + this.searchResults.length) % this.searchResults.length;
      this.highlightSearch();
    },

    highlightSearch() {
      // ì´ì „ í•˜ì´ë¼ì´íŠ¸ ì œê±°
      document.querySelectorAll('.highlighted').forEach(el => {
        el.classList.remove('highlighted');
      });

      if (this.currentResult === -1) return;

      const index = this.searchResults[this.currentResult];
      const elements = document.querySelectorAll('.line, .line-input');
      const el = elements[index];

      if (el) {
        el.classList.add('highlighted');
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    },
  }
}
function HighlightModule() {
  return {
    showHighlightModal: false,
    availableLanguages: hljs.listLanguages(),
    availableThemes: [
      "github.min.css",
      "github-dark.min.css",
      "atom-one-light.min.css",
      "atom-one-dark.min.css",
      "intellij-light.min.css",
      "rose-pine-dawn.min.css",
      "rose-pine-moon.min.css",
      "monokai.min.css",
    ],

    selectedLanguage: localStorage.getItem("hljsLanguage") ?? 'javascript',
    selectedTheme: localStorage.getItem("hljsTheme") ?? 'atom-one-light.min.css',

    applyHighlightSettings() {
      // í…Œë§ˆ CSS êµì²´
      const themeLinkId = 'hljs-theme-link';
      let linkEl = document.getElementById(themeLinkId);
      if (!linkEl) {
        linkEl = document.createElement('link');
        linkEl.id = themeLinkId;
        linkEl.rel = 'stylesheet';
        document.head.appendChild(linkEl);
      }
      linkEl.href = `https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/styles/${this.selectedTheme}`;


      // ì–¸ì–´ ì ìš©: highlight í˜¸ì¶œ ì‹œ selectedLanguage ì‚¬ìš©
      // ì˜ˆ: hljs.highlight(line.text, { language: this.selectedLanguage }).value

      // ëª¨ë‹¬ ë‹«ê¸°
      localStorage.setItem("hljsLanguage", this.selectedLanguage);
      localStorage.setItem("hljsTheme", this.selectedTheme);
      this.showHighlightModal = false;
    },
  }
}
function CreateCommand(command, p) {
  switch (command) {
    case 'delete':
      return {
        do: lines => {
          lines.splice(p.start, p.end - p.start + 1);
          p.afterDo?.();
          return lines;
        },
        undo: lines => {
          lines.splice(p.start, 0, ...materialize(p.lines));
          p.afterDo?.();
          return lines;
        },
      };
    case 'insert':
      return {
        do: lines => {
          lines.splice(p.index, 0, ...materialize(p.lines));
          p.afterDo?.();
          return lines;
        },
        undo: lines => {
          lines.splice(p.index, p.lines.length);
          p.afterDo?.();
          return lines;
        },
      };
    case 'replace':
      return {
        do: lines => {
          lines.splice(p.start, p.end - p.start + 1, ...materialize(p.newLines));
          p.afterDo?.();
          return lines;
        },
        undo: lines => {
          lines.splice(p.start, p.newLines.length, ...materialize(p.lines));
          p.afterDo?.();
          return lines;
        },
      };
  }
}
function EditorApp() {
  return {
    ...SearchModule(),
    ...HighlightModule(),
    mode: "editor",
    fileVisible: false,
    searchVisible: false,
    files: [
      generateFile("ì²« ë²ˆì§¸ ì¤„", "ë‘ ë²ˆì§¸ ì¤„"),
      generateFile("ì²« ë²ˆì§¸ ì¤„", "ë‘ ë²ˆì§¸ ì¤„"),
    ],
    currentFileIndex: 0,
    get lines() {
      return this.files[this.currentFileIndex].lines;
    },
    set lines(newLines) {
      this.files[this.currentFileIndex].lines = newLines;
    },
    get undoStack() {
      return this.files[this.currentFileIndex].undoStack;
    },
    set undoStack(newStack) {
      this.files[this.currentFileIndex].undoStack = newStack;
    },
    get redoStack() {
      return this.files[this.currentFileIndex].redoStack;
    },
    set redoStack(newStack) {
      this.files[this.currentFileIndex].redoStack = newStack;
    },
    get scroll() {
      return this.files[this.currentFileIndex].scroll;
    },
    set scroll(val) {
      this.files[this.currentFileIndex].scroll = val;
    },
    selection: null,
    get currentFile() {
      return this.files[this.currentFileIndex];
    },
    genId() {
      return this.currentFile.nextId++;
    },

    toggleMode() { this.mode = this.mode === "editor" ? "text" : "editor"; this.selection = null; },

    switchFile(i) {
      // í˜„ì¬ ìŠ¤í¬ë¡¤ ì €ì¥
      this.scroll = window.scrollY || window.pageYOffset;
      this.currentFileIndex = i;
      // ìƒˆ íŒŒì¼ ìŠ¤í¬ë¡¤ ë³µì›
      this.$nextTick(() => {
        window.scrollTo(0, this.scroll || 0);
      });
    },
    toggleSelect(i) {
      // ì„ íƒì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ì„ íƒ
      if (!this.selection) {
        this.selection = { start: i, end: i };
        this.lastClicked = i;
        return;
      }

      // ì„ íƒ ë²”ìœ„ê°€ í•œ ì¤„ì´ê³ , ê°™ì€ ì¤„ì„ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì·¨ì†Œ
      if (this.selection.start === this.selection.end && this.selection.start === i) {
        this.selection = null;
        this.lastClicked = null;
        return;
      }

      // ê¸°ì¡´ ë¡œì§: lastClicked ê¸°ì¤€ìœ¼ë¡œ ë²”ìœ„ ì¡°ì •
      if (i >= this.lastClicked) {
        this.selection.start = this.lastClicked;
        this.selection.end = i;
      } else {
        this.selection.start = i;
        this.selection.end = this.lastClicked;
      }

      this.lastClicked = i;
    },

    getSelectedLines() {
      if (!this.selection) return [];
      return this.lines.slice(this.selection.start, this.selection.end + 1);
    },
    selectAll() {
      if (this.lines.length === 0) return;
      this.selection = { start: 0, end: this.lines.length - 1 };
    },

    deleteSelection() {
      if (!this.selection) return;
      const { start, end } = this.selection;
      const lines = snapshotLines(this.lines.slice(start, end + 1));

      const cmd = CreateCommand('delete', {
        start, end, lines
      })
      this.execute(cmd);
    },

    execute(cmd) {
      const l = cmd.do(this.lines);
      if (l) this.lines = l;
      this.undoStack.push(cmd);
      this.redoStack = [];

      this.selection = null;
      this.saveFilesToStorage();
    },

    async writeClipboard(text, manual = false) {
      if (!manual) return;
      try { await navigator.clipboard.writeText(text); }
      catch (e) { console.warn("Clipboard write failed", e); }
    },

    manualCopy() {
      if (!this.selection) return;
      const text = this.getSelectedLines().map(l => l.text).join('\n');
      this.writeClipboard(text, true);
      this.selection = null;
    },

    manualCut() {
      if (!this.selection) return;
      const { start, end } = this.selection;
      const lines = snapshotLines(this.lines.slice(start, end + 1));

      const cmd = CreateCommand('delete', {
        start, end, lines
      })

      this.execute(cmd);
      this.writeClipboard(lines.map(l => l.text).join('\n'), true);
    },

    async paste() {
      try {
        const text = await navigator.clipboard.readText();
        if (!text) return;

        const lines = snapshotLines(
          text.split('\n').map(t => ({ id: this.genId(), text: t }))
        );
        const index = this.selection ? this.selection.end + 1 : this.lines.length;

        const cmd = CreateCommand('insert', {
          index, lines
        });

        this.execute(cmd);
      } catch (e) {
        console.warn("Clipboard read failed", e);
      }
    },

    async replace() {
      if (!this.selection) return;
      const { start, end } = this.selection;

      try {
        const text = await navigator.clipboard.readText();
        if (!text) return;

        const newLines = snapshotLines(
          text.split('\n').map(t => ({ id: this.genId(), text: t }))
        );
        const lines = snapshotLines(this.lines.slice(start, end + 1));

        const cmd = CreateCommand('replace', {
          start, end, lines, newLines
        })

        this.execute(cmd);
      } catch (e) {
        console.warn("Clipboard read failed", e);
      }
    },

    insertLine(i, event) {
      this.recordEdit(i);
      const input = event.target;
      const cursorPos = input.selectionStart;
      const value = input.value;

      const before = value.slice(0, cursorPos);
      const after = value.slice(cursorPos);

      const oldSnap = snapshotLines([this.lines[i]]);
      const newSnap = snapshotLines([
        { id: this.genId(), text: before },
        { id: this.genId(), text: after }
      ]);

      const cmd = CreateCommand('replace', {
        start: i,
        end: i, // í•œ ì¤„ë§Œ êµì²´í•˜ë¯€ë¡œ startì™€ endê°€ ê°™ìŒ
        lines: oldSnap, // ê¸°ì¡´ ì¤„ (undoìš©)
        newLines: newSnap, // ìƒˆ ì¤„ (doìš©)
        afterDo: () => {
          this.$nextTick(() => {
            const inputs = document.querySelectorAll('input.line-input');
            const nextInput = inputs[i + 1];
            if (nextInput) {
              nextInput.focus();
              nextInput.setSelectionRange(0, 0);
            }
          });
        },
        afterUndo: () => {
          this.$nextTick(() => {
            const inputs = document.querySelectorAll('input.line-input');
            if (inputs[i]) inputs[i].focus();
          });
        }
      });

      this.execute(cmd);
    },
    mergeWithPrev(i, event) {
      this.recordEdit(i);
      const input = event.target;
      const cursorPos = input.selectionStart;

      if (cursorPos !== 0) return;
      if (i === 0) return;
      event.preventDefault();

      const prevSnap = snapshotLines([this.lines[i - 1]]);
      const currSnap = snapshotLines([this.lines[i]]);
      const mergedSnap = snapshotLines([
        { id: this.genId(), text: prevSnap[0].text + currSnap[0].text }
      ]);

      const cmd = CreateCommand('replace', {
        start: i - 1,
        end: i, // ë‘ ì¤„ ë³‘í•©ì´ë¯€ë¡œ startë¶€í„° endê¹Œì§€ êµì²´
        lines: [...prevSnap, ...currSnap], // undoìš© ì›ë˜ ì¤„ë“¤
        newLines: mergedSnap, // ë³‘í•©ëœ ì¤„ (doìš©)
        afterDo: () => {
          this.$nextTick(() => {
            const inputs = document.querySelectorAll('input.line-input');
            const newInput = inputs[i - 1];
            if (newInput) {
              const pos = prevSnap[0].text.length;
              newInput.focus();
              newInput.setSelectionRange(pos, pos);
            }
          });
        },
        afterUndo: () => {
          this.$nextTick(() => {
            const inputs = document.querySelectorAll('input.line-input');
            const currInput = inputs[i];
            if (currInput) {
              currInput.focus();
              currInput.setSelectionRange(0, 0);
            }
          });
        }
      });

      this.execute(cmd);
    },
    recordEdit(i) {
      const oldText = this.lines[i]._oldText;
      const newText = this.lines[i].text;
      if (oldText === newText) return;

      const lines = [{ id: this.lines[i].id, text: oldText }];
      const newLines = [{ id: this.lines[i].id, text: newText }];

      const cmd = CreateCommand('replace', {
        start: i, end: i, lines, newLines
      });

      this.execute(cmd);
    },

    undo() {
      if (this.undoStack.length === 0) return;
      const cmd = this.undoStack.pop();
      const l = cmd.undo?.(this.lines);
      if (l) this.lines = l;
      this.redoStack.push(cmd);

      this.selection = null;
      this.saveFilesToStorage();
    },

    redo() {
      if (this.redoStack.length === 0) return;
      const cmd = this.redoStack.pop();
      const l = cmd.do?.(this.lines);
      if (l) this.lines = l;
      this.undoStack.push(cmd);

      this.selection = null;
      this.saveFilesToStorage();
    },
    saveFilesToStorage() {
      localStorage.setItem("editorFiles", JSON.stringify(this.files
        .map(v => v.lines.length === 0 ? [''] : v.lines.map( 
          f => f.text
        ))
      ));
    },

    loadFilesFromStorage() {
      const saved = localStorage.getItem("editorFiles");
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          if (typeof parsed[0][0] === 'string') {
            const builded = parsed.map(v => generateFile(...v));
            this.files.splice(0, this.files.length, ...builded);
            console.log('[EDITOR] data restored: ', parsed);
          }
          else {
            this.files.splice(0, this.files.length, ...parsed);
            console.log('[EDITOR] data restored: ', parsed);
          }
        } catch (e) {
          console.log("[EDITOR] failed to parse data, use default data instead:", e);
        }
      }
    },

    init() {
      this.applyHighlightSettings();
      this.loadFilesFromStorage();
    },
  }
}
</script>
</body>
</html>
